{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-4">
    <h2>Filtered 8-K Filings</h2>
    <div class="d-flex gap-2">
        {% if last_backfill %}
        <span class="badge bg-info fs-6">
            Last updated: {{ last_backfill.time.strftime('%b %d, %Y at %I:%M %p') }} ({{ last_backfill.type }})
        </span>
        {% endif %}
        <span class="badge bg-secondary fs-6">{{ total_count }} total filings in database</span>
    </div>
</div>

<!-- Filter controls -->
<div class="card mb-4">
    <div class="card-body">
        <form method="GET" action="/" class="row g-3">
            <!-- Category dropdown -->
            <div class="col-md-3">
                <label class="form-label">Category</label>
                <select name="category" class="form-select">
                    <option value="">All Categories</option>
                    {% for cat in categories %}
                    <option value="{{ cat }}" {{ 'selected' if cat == current_category }}>{{ cat }}</option>
                    {% endfor %}
                </select>
            </div>

            <!-- Search box -->
            <div class="col-md-3">
                <label class="form-label">Search</label>
                <input type="text" name="search" class="form-control"
                       placeholder="Company, ticker, or keyword..."
                       value="{{ current_search }}">
            </div>

            <!-- Date range -->
            <div class="col-md-2">
                <label class="form-label">From</label>
                <input type="date" name="date_from" class="form-control" value="{{ current_date_from }}">
            </div>
            <div class="col-md-2">
                <label class="form-label">To</label>
                <input type="date" name="date_to" class="form-control" value="{{ current_date_to }}">
            </div>

            <!-- Urgent only toggle -->
            <div class="col-md-2 d-flex align-items-end gap-2">
                <div class="form-check mb-2">
                    <input type="checkbox" name="urgent" value="1" class="form-check-input"
                           id="urgentCheck" {{ 'checked' if current_urgent }}>
                    <label class="form-check-label" for="urgentCheck">
                        <span class="badge bg-danger">URGENT</span> only
                    </label>
                </div>
            </div>

            <div class="col-md-2 d-flex align-items-end gap-2">
                <button type="submit" class="btn btn-primary">Filter</button>
                <a href="/" class="btn btn-outline-secondary">Clear</a>
            </div>
        </form>
    </div>
</div>

<!-- Results table -->
{% if filings %}
<div class="table-responsive">
    <table class="table table-hover">
        <thead class="table-dark">
            <tr>
                <th style="width: 40px;"></th>
                <th></th>
                <th>Date</th>
                <th>Company</th>
                <th>Ticker</th>
                <th>Category</th>
                <th>Sub-Category</th>
                <th>Summary</th>
                <th>Link</th>
            </tr>
        </thead>
        <tbody>
            {% for filing in filings %}
            <tr class="clickable-row" onclick="window.location='/filing/{{ filing['id'] }}?back={{ ('/?page=' ~ current_page ~ '&category=' ~ current_category ~ '&search=' ~ current_search ~ '&date_from=' ~ current_date_from ~ '&date_to=' ~ current_date_to ~ '&urgent=' ~ ('1' if current_urgent else ''))|urlencode }}'">
                <!-- Watchlist star toggle -->
                <td onclick="event.stopPropagation()">
                    <button class="btn btn-link p-0 watchlist-star" data-filing-id="{{ filing['id'] }}"
                            data-watchlisted="{{ 'true' if filing['id'] in watchlist_ids else 'false' }}"
                            title="{{ 'Remove from watchlist' if filing['id'] in watchlist_ids else 'Add to watchlist' }}">
                        {% if filing['id'] in watchlist_ids %}
                        <span class="star-filled" style="color: #ffc107; font-size: 1.2rem;">&#9733;</span>
                        {% else %}
                        <span class="star-empty" style="color: #6c757d; font-size: 1.2rem;">&#9734;</span>
                        {% endif %}
                    </button>
                </td>
                <td>
                    {% if filing['urgent'] %}
                        <span class="badge bg-danger">URGENT</span>
                    {% endif %}
                </td>
                <td class="text-nowrap">{{ filing['filed_date'] }}</td>
                <td>{{ filing['company'] }}</td>
                <td>
                    <strong>{{ filing['ticker'] or '—' }}</strong>
                    {% if filing['ticker'] and market_caps.get(filing['ticker']) %}
                    <br><span class="market-cap">{{ market_caps[filing['ticker']] | format_market_cap }}</span>
                    {% endif %}
                </td>
                <td>
                    <!-- Show user tag if set, otherwise auto category -->
                    {% set display_category = filing['user_tag'] or filing['auto_category'] %}
                    <span class="badge
                        {% if display_category == 'Management Change' %}bg-primary
                        {% elif display_category == 'Compensation' %}bg-success
                        {% elif display_category == 'Both' %}bg-warning text-dark
                        {% else %}bg-info
                        {% endif %}">
                        {{ display_category or 'Uncategorized' }}
                    </span>
                </td>
                <td class="text-muted small">{{ filing['auto_subcategory'] or '—' }}</td>
                <td class="summary-cell">
                    {% if filing['_comp'] %}
                        {% if filing['_comp']['vesting_target_price'] %}
                            <span class="badge bg-light text-dark border me-1">Target: {{ filing['_comp']['vesting_target_price'] }}</span>
                        {% elif filing['_comp']['grant_value'] %}
                            <span class="badge bg-light text-dark border me-1">{{ filing['_comp']['grant_value'] }}</span>
                        {% endif %}
                    {% endif %}
                    {{ filing['summary'][:150] }}{{ '...' if filing['summary'] and filing['summary']|length > 150 }}
                </td>
                <td>
                    <a href="{{ filing['filing_url'] }}" target="_blank" class="btn btn-sm btn-outline-primary"
                       onclick="event.stopPropagation()">SEC</a>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Numbered pagination -->
{% set q = '&category=' ~ current_category ~ '&search=' ~ current_search ~ '&date_from=' ~ current_date_from ~ '&date_to=' ~ current_date_to ~ '&urgent=' ~ ('1' if current_urgent else '') %}
<nav aria-label="Page navigation">
    <ul class="pagination justify-content-center flex-wrap">
        <!-- Previous button -->
        <li class="page-item {{ 'disabled' if current_page == 1 }}">
            <a class="page-link" href="?page={{ current_page - 1 }}{{ q }}">Previous</a>
        </li>

        <!-- Page numbers with ellipsis for large page counts -->
        {% for p in range(1, total_pages + 1) %}
            {% if p == 1 or p == total_pages or (p >= current_page - 2 and p <= current_page + 2) %}
                <li class="page-item {{ 'active' if p == current_page }}">
                    <a class="page-link" href="?page={{ p }}{{ q }}">{{ p }}</a>
                </li>
            {% elif p == current_page - 3 or p == current_page + 3 %}
                <li class="page-item disabled"><span class="page-link">...</span></li>
            {% endif %}
        {% endfor %}

        <!-- Next button -->
        <li class="page-item {{ 'disabled' if current_page == total_pages }}">
            <a class="page-link" href="?page={{ current_page + 1 }}{{ q }}">Next</a>
        </li>
    </ul>
</nav>

{% else %}
<div class="text-center py-5">
    <h4 class="text-muted">No filings found</h4>
    <p class="text-muted">Try adjusting your filters or <a href="/backfill">run a backfill</a> to fetch historical filings.</p>
</div>
{% endif %}

<!-- JavaScript for watchlist star toggle -->
<script>
document.addEventListener('DOMContentLoaded', function() {
    // Handle star button clicks
    document.querySelectorAll('.watchlist-star').forEach(function(btn) {
        btn.addEventListener('click', function(e) {
            e.preventDefault();
            var filingId = this.dataset.filingId;
            var isWatchlisted = this.dataset.watchlisted === 'true';
            var button = this;

            // Determine which endpoint to call
            var url = isWatchlisted
                ? '/watchlist/remove/' + filingId
                : '/watchlist/add/' + filingId;

            // Send AJAX request
            fetch(url, {
                method: 'POST',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(function(response) { return response.json(); })
            .then(function(data) {
                if (data.success) {
                    // Toggle the star appearance
                    if (data.action === 'added') {
                        button.dataset.watchlisted = 'true';
                        button.innerHTML = '<span class="star-filled" style="color: #ffc107; font-size: 1.2rem;">&#9733;</span>';
                        button.title = 'Remove from watchlist';
                    } else {
                        button.dataset.watchlisted = 'false';
                        button.innerHTML = '<span class="star-empty" style="color: #6c757d; font-size: 1.2rem;">&#9734;</span>';
                        button.title = 'Add to watchlist';
                    }
                }
            })
            .catch(function(err) {
                console.error('Watchlist toggle failed:', err);
            });
        });
    });
});
</script>

{% endblock %}
