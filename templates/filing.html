{% extends "base.html" %}
{% block content %}

<a href="{{ back_url }}" class="btn btn-outline-secondary mb-3">&larr; Back to Dashboard</a>

<div class="card">
    <div class="card-header d-flex justify-content-between align-items-center">
        <h3 class="mb-0">{{ filing['company'] }}</h3>
        <div class="d-flex gap-2">
            {% if filing['urgent'] %}
                <span class="badge bg-danger fs-6">URGENT</span>
            {% endif %}
            <span class="badge bg-secondary fs-6">{{ filing['ticker'] or 'No Ticker' }}</span>
        </div>
    </div>
    <div class="card-body">

        <!-- Filing metadata -->
        <div class="row mb-4">
            <div class="col-md-6">
                <table class="table table-sm">
                    <tr><th>Filed Date</th><td>{{ filing['filed_date'] }}</td></tr>
                    <tr><th>CIK</th><td>{{ filing['cik'] }}</td></tr>
                    <tr><th>Accession No.</th><td>{{ filing['accession_no'] }}</td></tr>
                    <tr><th>Item Codes</th><td>{{ filing['item_codes'] }}</td></tr>
                    <tr>
                        <th>SEC Filing</th>
                        <td><a href="{{ filing['filing_url'] }}" target="_blank">View on SEC.gov</a></td>
                    </tr>
                </table>
            </div>
            <div class="col-md-6">
                <table class="table table-sm">
                    <tr>
                        <th>Auto Category</th>
                        <td>
                            <span class="badge
                                {% if filing['auto_category'] == 'Management Change' %}bg-primary
                                {% elif filing['auto_category'] == 'Compensation' %}bg-success
                                {% elif filing['auto_category'] == 'Both' %}bg-warning text-dark
                                {% else %}bg-info{% endif %}">
                                {{ filing['auto_category'] or '—' }}
                            </span>
                        </td>
                    </tr>
                    <tr><th>Auto Sub-Category</th><td>{{ filing['auto_subcategory'] or '—' }}</td></tr>
                    <tr>
                        <th>User Tag</th>
                        <td>
                            {% if filing['user_tag'] %}
                            <span class="badge bg-dark">{{ filing['user_tag'] }}</span>
                            {% else %}
                            <span class="text-muted">Not set</span>
                            {% endif %}
                        </td>
                    </tr>
                    <tr><th>Matched Keywords</th><td class="small">{{ filing['matched_keywords'] }}</td></tr>
                </table>
            </div>
        </div>

        <!-- Tag override form -->
        <div class="card mb-4">
            <div class="card-body">
                <h5>Update Tag</h5>
                <form method="POST" action="/update-tag/{{ filing['id'] }}" class="d-flex gap-2">
                    <select name="user_tag" class="form-select" style="max-width: 300px;">
                        <option value="">— Clear Tag —</option>
                        {% for tag in tag_options %}
                        <option value="{{ tag }}" {{ 'selected' if filing['user_tag'] == tag }}>{{ tag }}</option>
                        {% endfor %}
                    </select>
                    <button type="submit" class="btn btn-primary">Save</button>
                </form>
            </div>
        </div>

        <!-- Watchlist controls -->
        <div class="card mb-4">
            <div class="card-body">
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <h5 class="mb-0">Watchlist</h5>
                    {% if is_watchlisted %}
                    <form method="POST" action="/watchlist/remove/{{ filing['id'] }}" class="d-inline">
                        <button type="submit" class="btn btn-outline-danger btn-sm">
                            Remove from Watchlist
                        </button>
                    </form>
                    {% else %}
                    <form method="POST" action="/watchlist/add/{{ filing['id'] }}" class="d-inline">
                        <button type="submit" class="btn btn-warning btn-sm">
                            Add to Watchlist
                        </button>
                    </form>
                    {% endif %}
                </div>

                {% if is_watchlisted %}
                <!-- Notes form (only shown when watchlisted) -->
                <form method="POST" action="/watchlist/notes/{{ filing['id'] }}">
                    <div class="mb-2">
                        <textarea name="notes" class="form-control" rows="3"
                            placeholder="Add your notes about this filing...">{{ watchlist_notes }}</textarea>
                    </div>
                    <button type="submit" class="btn btn-primary btn-sm">Save Notes</button>
                </form>
                {% else %}
                <p class="text-muted small mb-0">Add to watchlist to save notes on this filing.</p>
                {% endif %}
            </div>
        </div>

        <!-- Compensation Details (only shown when data exists) -->
        {% if filing['_comp'] %}
        <div class="card mb-4">
            <div class="card-header"><h5 class="mb-0">Compensation Details</h5></div>
            <div class="card-body">
                <table class="table table-sm comp-details-table">
                    {% if filing['_comp']['grant_value'] %}
                    <tr><th>Grant Value</th><td>{{ filing['_comp']['grant_value'] }}</td></tr>
                    {% endif %}
                    {% if filing['_comp']['grant_type'] %}
                    <tr><th>Grant Type</th><td>{{ filing['_comp']['grant_type'] }}</td></tr>
                    {% endif %}
                    {% if filing['_comp']['vesting_target_price'] %}
                    <tr><th>Vesting Target Price</th><td>{{ filing['_comp']['vesting_target_price'] }}</td></tr>
                    {% endif %}
                    {% if filing['_comp']['performance_hurdles'] %}
                    <tr><th>Performance Hurdles</th><td>{{ filing['_comp']['performance_hurdles'] }}</td></tr>
                    {% endif %}
                    {% if filing['_comp']['stock_vs_cash_election'] %}
                    <tr><th>Stock vs Cash Election</th><td>{{ filing['_comp']['stock_vs_cash_election'] }}</td></tr>
                    {% endif %}
                </table>
            </div>
        </div>
        {% endif %}

        <!-- Summary -->
        <div class="card">
            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Summary</h5>
                <form method="POST" action="/reanalyze/{{ filing['id'] }}" class="d-inline"
                      onsubmit="this.querySelector('button').disabled=true; this.querySelector('button').innerHTML='Analyzing...';">
                    <button type="submit" class="btn btn-outline-info btn-sm">
                        Re-analyze with GPT-5.2
                    </button>
                </form>
            </div>
            <div class="card-body">
                <p>{{ filing['summary'] or 'No summary available' }}</p>
            </div>
        </div>

    </div>
</div>

{% endblock %}
